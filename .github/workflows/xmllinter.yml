---

on:  # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      repository:
        description: 'The repository that needs linting'
        type: string
        default: ${{ github.repository }}
        required: false
      ref:
        description: 'The branch, tag or SHA that needs linting'
        type: string
        required: false
        default: ${{ github.ref }}
      config_file:
        description: 'The location of the linter-configuration'
        type: string
        required: false
        default: 'tools/linters/xmllinter.json'
  workflow_dispatch:

jobs:
  linter:
    runs-on: ubuntu-latest

    steps:
      - name: Install required tools
        run: sudo apt-get -y install jo

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}

      - name: Read JSON file  # this puts the whole JSON file in the read-json step output
        id: read-json
        run: |  # to read multi-line JSON file and not bother with escaping
          if [ -f "${{ inputs.config_file }}" ]; then
            {
                echo "config<<EOF";
                cat "${{ inputs.config_file }}";
                echo "EOF";
            } >> "$GITHUB_OUTPUT"
          else
            echo "config={}" >> "$GITHUB_OUTPUT"
          fi

      - name: Substract ignore-list from config
        id: read-ignore
        run: |
          IGNORE="$(echo '${{ toJSON(fromJSON(steps.read-json.outputs.config).ignore) }}' | jq -c '.')"
          echo "ignore=${IGNORE}" >> "$GITHUB_OUTPUT"

      - name: Find all XML-files in this repository
        id: find-xml
        run: |
          filelist="$(find . -type f -iname "*.xml" | jo -a)"
          echo "filelist=${filelist}" >> "$GITHUB_OUTPUT"

      - name: Lint XML
        id: linter
        run: |
          echo '${{ steps.find-xml.outputs.filelist }}' | jq -c '.[]' | while read -r i; do
            ignore=$(jq --null-input '["${i}"] - ${{ steps.read-ignore.outputs.ignore }}')
            echo "$ignore"

            if [ "$ignore" = "[]" ]; then
              echo "Skipping ${i}"
            else
              echo "Linting ${i}"
            fi
          done
